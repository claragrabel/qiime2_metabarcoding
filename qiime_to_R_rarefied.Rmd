---
title: "qiime_to_R_rarefied"
author: "Clara Granado Beltran"
date: "2025-02-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
title: "qiime_to_R_import"
author: "Clara Granado Beltran"
date: "2025-02-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preparing the environment

```{r}
# Install necessary packages if missing
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")

# Load required packages
pacman::p_load(phyloseq, vegan, ggplot2, qiime2R, ggtree, pheatmap, tidyr, tidyverse, ggpubr)
```

## Importing the .qza files

Import the `.qza` files generated by QIIME2 and explore the data in R format using `qiime2R`.

```{r}
# Import data using the rarefied OTU table
otu_table <- read_qza("~/Desktop/clara/marco/results/rarefied-otu-table.qza")
print(otu_table$type)
head(otu_table$data[1:5, 1:5])  # Show first 5 samples and first 5 taxa

metadata <- read_q2metadata("~/Desktop/clara/marco/results/sample-metadata-R.tsv")
head(metadata)

taxonomy <- read_qza("~/Desktop/clara/marco/results/taxonomy.qza")
taxonomy <- parse_taxonomy(taxonomy$data)  # Convert taxonomy to proper format
head(taxonomy)
```

## Create a phyloseq object

```{r}
physeq <- qza_to_phyloseq(
    features="~/Desktop/clara/marco/results/rarefied-otu-table.qza",
    tree="~/Desktop/clara/marco/results/rooted-tree.qza",
    taxonomy="~/Desktop/clara/marco/results/taxonomy.qza",
    metadata="~/Desktop/clara/marco/results/sample-metadata-R.tsv"
)
print(physeq)
```

## Alpha Diversity Analysis

### Observed OTUs

```{r}
# Compute richness
observed_otus <- estimate_richness(physeq, measures="Observed")
observed_otus$SampleID <- rownames(observed_otus)
observed_otus$Position <- sample_data(physeq)$position

# Barplot of observed OTUs per sample
ggplot(observed_otus, aes(x=SampleID, y=Observed, fill=Position)) +
  geom_bar(stat="identity", position="dodge") +
  theme_minimal() +
  labs(title="Observed OTUs per Sample", y="Observed OTUs", x="Sample ID") +
  theme(axis.text.x = element_text(angle=90, hjust=1))
```

```{r}
# Boxplot of observed OTUs by tree position
ggplot(observed_otus, aes(x=Position, y=Observed, fill=Position)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title="Observed OTUs by Tree Position", y="Observed OTUs", x="Tree Position")
```

### Shannon Diversity Index

```{r}
# Compute Shannon Diversity
shannon_div <- estimate_richness(physeq, measures="Shannon")
shannon_div$SampleID <- rownames(shannon_div)
shannon_div$Position <- sample_data(physeq)$position

# Barplot
ggplot(shannon_div, aes(x=SampleID, y=Shannon, fill=Position)) +
  geom_bar(stat="identity", position="dodge") +
  theme_minimal() +
  labs(title="Shannon Diversity Index", y="Shannon Index (ln)", x="Sample ID") +
  theme(axis.text.x = element_text(angle=90, hjust=1))
```

```{r}
# Boxplot of Shannon Diversity by tree position
ggplot(shannon_div, aes(x=Position, y=Shannon, fill=Position)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title="Shannon Diversity by Tree Position", y="Shannon Index (ln)", x="Tree Position")
```

## Beta Diversity Analysis

### Bray-Curtis Distance Matrix

```{r}
# Compute Bray-Curtis distance matrix
dist_matrix <- phyloseq::distance(physeq, method="bray")
bray_matrix <- as.matrix(dist_matrix)

summary(as.vector(bray_matrix))  # Check value range (should be between 0-1)
any(is.na(bray_matrix))  # Check if there are NA values
dim(bray_matrix)  # Ensure dimensions match sample count

# Heatmap
pheatmap(bray_matrix, 
         clustering_distance_rows=as.dist(bray_matrix),
         clustering_distance_cols=as.dist(bray_matrix),
         display_numbers=TRUE)

# Run PERMANOVA
permanova <- adonis2(dist_matrix ~ position, data=metadata, permutations=999)
print(permanova)
```

### PCoA Analysis

```{r}
# Compute Weighted UniFrac distance
wunifrac_dist <- phyloseq::distance(physeq, method="wunifrac")
ordination <- ordinate(physeq, method="PCoA", distance=wunifrac_dist)

# Extract PCoA data
pcoa_data <- as.data.frame(ordination$vectors)
pcoa_data$SampleID <- rownames(pcoa_data)
pcoa_data$Position <- metadata$position[match(pcoa_data$SampleID, metadata$SampleID)]

# PCoA plot
ggplot(pcoa_data, aes(x=Axis.1, y=Axis.2, color=Position)) +
  geom_point(size=4, alpha=0.8) +
  theme_minimal() +
  labs(title="PCoA of Weighted UniFrac Distance", x="PC1", y="PC2")
```

### PCoA with Shannon Diversity

```{r}
# Match Shannon Index to PCoA data
pcoa_data$Shannon <- shannon_div$Shannon[match(pcoa_data$SampleID, shannon_div$SampleID)]

ggplot(pcoa_data, aes(x=Axis.1, y=Axis.2, color=Position, size=Shannon)) +
  geom_point(alpha=0.8) +
  theme_minimal() +
  labs(title="PCoA with Shannon Diversity", x="PC1", y="PC2") +
  scale_size_continuous(name="Shannon Diversity")
```


