---
title: "qiime_to_R_import"
author: "Clara Granado Beltran"
date: "2025-02-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preparing the environment

```{r}
# Code to install qiime2R

# if (!requireNamespace("devtools", quietly = TRUE)){install.packages("devtools")}
# devtools::install_github("jbisanz/qiime2R")

pacman::p_load(phyloseq, vegan, ggplot2, qiime2R, ggtree, pheatmap, tidyr, tidyverse, ggpubr)

# phyloseq: For microbiome analysis
# qiime2R: To import QIIME2 .qza files
# vegan: For diversity metrics & PERMANOVA
# ggplot2: For plotting
```

## Importing the .qza files

Importing the .qza resulting from qiime2 and exploring the data in the R format generated by qiime2R.

The read_qza function needs the file path of the .qza object we want to import.

Documentation: https://github.com/jbisanz/qiime2R

```{r}

otu_table<-read_qza("~/Desktop/clara/marco/results/table.qza")
otu_table$data[1:5,1:5] #show first 5 samples and first 5 taxa
otu_table$type

metadata<-read_q2metadata("~/Desktop/clara/marco/results/sample-metadata-R.tsv")
head(metadata) # show top lines of metadata

taxonomy<-read_qza("~/Desktop/clara/marco/results/taxonomy.qza")
head(taxonomy$data)

taxonomy<-parse_taxonomy(taxonomy$data) # convert taxonomy to proper format for phyloseq
head(taxonomy)

```

## Create a phyloseq object

We will be working with the phyloseq package to analyze data imported from qiime2.

Documentation: https://joey711.github.io/phyloseq/index.html
https://www.rdocumentation.org/packages/phyloseq/versions/1.16.2

```{r}

physeq<-qza_to_phyloseq(
    features="~/Desktop/clara/marco/results/otu-table.qza",
    tree="~/Desktop/clara/marco/results/rooted-tree.qza",
    taxonomy="~/Desktop/clara/marco/results/taxonomy.qza",
    metadata = "~/Desktop/clara/marco/results/sample-metadata-R.tsv"
    )
physeq
```

### Observed OTUs

Comparing richness across samples.

```{r}
observed_otus <- estimate_richness(physeq, measures="Observed")

observed_otus$Position <- sample_data(physeq)$position   # Add sample ID for plotting

observed_otus$SampleID <- rownames(observed_otus)   # Add metadata

ggplot(observed_otus, aes(x=SampleID, y=Observed, fill=Position)) +
  geom_bar(stat="identity", position="dodge") +
  theme_minimal() +
  labs(title="Observed OTUs per Sample", y="Observed OTUs", x="Sample ID") +
  theme(axis.text.x = element_text(angle=90, hjust=1))


```


Comparing between tree positions.

```{r}
ggplot(observed_otus, aes(x=Position, y=Observed, fill=Position)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title="Observed OTUs by Tree Position", y="Observed OTUs", x="Tree Position")

```


### Shannon Diversity Index

Comparing individual sample diversity.

```{r}

# Calculate 

shannon_div <- estimate_richness(physeq, measures="Shannon")  # estimate_richness() automatically uses the natural logarithm (ln) for Shannon diversity
shannon_div$SampleID <- rownames(shannon_div)  # Add sample ID for plotting
shannon_div$Position <- sample_data(physeq)$position  # Add metadata

# Plot

ggplot(shannon_div, aes(x=SampleID, y=Shannon, fill=Position)) +
  geom_bar(stat="identity", position="dodge") +
  theme_minimal() +
  labs(title="Shannon Diversity Index", y="Shannon Index (ln)", x="Sample ID") +
  theme(axis.text.x = element_text(angle=90, hjust=1))  # Rotate labels


```

Comparing across tree positions.

```{r}
ggplot(shannon_div, aes(x=Position, y=Shannon, fill=Position)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title="Shannon Diversity by Tree Position", y="Shannon Index (ln)", x="Tree Position")

```


### Bray-Curtis distance matrix

```{r}
# Compute 
dist_matrix <- phyloseq::distance(physeq, method="bray")

# Convert to matrix for plotting
bray_matrix <- as.matrix(dist_matrix)

# Create Heatmap
pheatmap(bray_matrix, clustering_distance_rows=dist_matrix, clustering_distance_cols=dist_matrix) # Shows similarity between samples using clustering

# Run PERMANOVA
permanova <- adonis2(dist_matrix ~ position, data=metadata, permutations=999)
print(permanova)

```

### PCoA

```{r}
# Compute Weighted UniFrac distance
wunifrac_dist <- phyloseq::distance(physeq, method="wunifrac")

# Perform PCoA
ordination <- ordinate(physeq, method="PCoA", distance=wunifrac_dist)

# Extract PCoA data for ggplot
pcoa_data <- plot_ordination(physeq, ordination, type="samples", justDF=TRUE) %>%
  left_join(sample_data(physeq) %>% as.data.frame() %>% rownames_to_column("SampleID"), by="SampleID")

ggplot(pcoa_data, aes(x=Axis.1, y=Axis.2, color=position)) +
  geom_point(size=4, alpha=0.8) +
  theme_minimal() +
  labs(title="PCoA of Weighted UniFrac Distance", x="PC1", y="PC2")

```

#### PCoA with Shannon Diversity as Point Size

To see correlation

```{r}
ggplot(pcoa_data, aes(x=Axis.1, y=Axis.2, color=position, size=Shannon)) +
  geom_point(alpha=0.8) +
  theme_minimal() +
  labs(title="PCoA with Shannon Diversity", x="PC1", y="PC2") +
  scale_size_continuous(name="Shannon Diversity")

```

